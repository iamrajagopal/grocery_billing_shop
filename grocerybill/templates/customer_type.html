<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Customer Type</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
    display: flex; justify-content: center; align-items: center;
    min-height: 100vh;
    color: #2c3e50;
  }

  /* Container for form card */
  .container {
    background: #ffffffdd;
    backdrop-filter: saturate(180%) blur(10px);
    border-radius: 16px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    padding: 36px 40px 40px 40px;
    width: 100%;
    max-width: 480px;
    transition: transform 0.3s ease;
  }
  .container:hover {
    transform: translateY(-8px);
  }

  /* Title */
  h2 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 28px;
    text-align: center;
    color: #1a237e;
    user-select: none;
    letter-spacing: 0.05em;
  }

  /* Radio buttons with custom styling */
  label {
    display: flex;
    align-items: center;
    font-weight: 600;
    margin-bottom: 20px;
    cursor: pointer;
    font-size: 1.1rem;
    user-select: none;
  }
  label input[type="radio"] {
    appearance: none;
    -webkit-appearance: none;
    background-color: #e4e7ea;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    margin-right: 14px;
    position: relative;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    transition: background-color 0.3s ease;
  }
  label input[type="radio"]:checked {
    background-color: #1a237e;
  }
  label input[type="radio"]:checked::after {
    content: "";
    display: block;
    position: absolute;
    top: 5px; left: 5px;
    width: 12px; height: 12px;
    border-radius: 50%;
    background: white;
  }
  label input[type="radio"]:focus-visible {
    outline: 2px solid #3f51b5;
    outline-offset: 3px;
  }

  /* Section containers */
  #existingCustomerSection, #newCustomerSection {
    margin-top: 28px;
    padding-top: 18px;
    border-top: 2px solid #ddd;
    transition: max-height 0.4s ease, opacity 0.4s ease;
  }

  /* Form inputs */
  input[type="text"], input[type="email"], textarea {
    width: 100%;
    padding: 14px 16px;
    margin-top: 8px;
    margin-bottom: 18px;
    border: 2px solid #ccc;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
    color: #1a237e;
    transition: border-color 0.3s ease;
    resize: vertical;
  }
  input[type="text"]:focus, input[type="email"]:focus, textarea:focus {
    border-color: #3f51b5;
    outline: none;
    box-shadow: 0 0 8px rgba(63, 81, 181, 0.3);
  }
  textarea {
    height: 90px;
  }

  /* Submit button */
  button {
    display: block;
    width: 100%;
    background-color: #1a237e;
    color: #fff;
    padding: 16px 0;
    font-size: 1.15rem;
    font-weight: 700;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 6px 16px rgba(26, 35, 126, 0.45);
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  button:hover, button:focus-visible {
    background-color: #3949ab;
    box-shadow: 0 8px 22px rgba(57, 73, 171, 0.65);
    outline: none;
  }

  /* Smooth show/hide of sections */
  #existingCustomerSection.hide, #newCustomerSection.hide {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    padding-top: 0;
    margin-top: 0;
    border-top: none;
  }

</style>
</head>
<body>
<div class="container">
  <h2>Select Customer Type</h2>
  <form id="customerForm">
    <label>
      <input type="radio" name="customerType" value="existing" checked />
      Existing Customer
    </label>
    <label>
      <input type="radio" name="customerType" value="new" />
      New Customer
    </label>
    <div id="existingCustomerSection">
      <label for="existingIdentifier">Enter your Email or Phone:</label>
      <input id="existingIdentifier" name="existingIdentifier" type="text" placeholder="Email or Phone" required />
    </div>
    <div id="newCustomerSection" style="display:none;">
      <label for="newName">Name:</label>
      <input id="newName" name="newName" type="text" placeholder="Full Name" />
      <label for="newEmail">Email:</label>
      <input id="newEmail" name="newEmail" type="email" placeholder="Email Address" />
      <label for="newPhone">Phone:</label>
      <input id="newPhone" name="newPhone" type="text" placeholder="Phone Number" />
      <label for="newAddress">Address:</label>
      <textarea id="newAddress" name="newAddress" placeholder="Address"></textarea>
    </div>
    <button type="submit">Proceed</button>
  </form>
</div>

<script>
  // Calculate total amount from localStorage cartData array
  function calculateTotalAmount() {
    const cart = JSON.parse(localStorage.getItem('cartData') || '[]');
    if (!Array.isArray(cart) || cart.length === 0) return 0;
    return cart.reduce((sum, item) => {
      const price = parseFloat(item.price) || 0;
      const qty = parseInt(item.quantity || item.qty || 0);
      return sum + price * qty;
    }, 0).toFixed(2);
  }

  const customerForm = document.getElementById('customerForm');

  // Toggle customer detail sections based on customer type
  const toggleSections = () => {
    const selected = document.querySelector('input[name="customerType"]:checked').value;
    if (selected === 'existing') {
      document.getElementById('existingCustomerSection').style.display = 'block';
      document.getElementById('newCustomerSection').style.display = 'none';
      document.getElementById('existingIdentifier').required = true;
      document.getElementById('newName').required = false;
      document.getElementById('newEmail').required = false;
    } else {
      document.getElementById('existingCustomerSection').style.display = 'none';
      document.getElementById('newCustomerSection').style.display = 'block';
      document.getElementById('existingIdentifier').required = false;
      document.getElementById('newName').required = true;
      document.getElementById('newEmail').required = true;
    }
  };

  document.querySelectorAll('input[name="customerType"]').forEach(input => {
    input.addEventListener('change', toggleSections);
  });
  toggleSections(); // initial toggle

  // Common success handler
  function handleCustomerSuccess(type, customerData) {
    const totalAmount = calculateTotalAmount();
    alert(`Customer ${type === 'existing' ? 'found' : 'added'} successfully. Proceeding to payment.`);
    localStorage.setItem('customerType', type);
    localStorage.setItem('customerData', JSON.stringify(customerData));
    localStorage.setItem('totalAmount', totalAmount); // optional storage for payment page
    window.location.href = `/payment_method?total_amount=${totalAmount}`;
  }

  // Form submit handler
  customerForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const customerType = document.querySelector('input[name="customerType"]:checked').value;

    if (customerType === 'existing') {
      const identifier = document.getElementById('existingIdentifier').value.trim();
      if (!identifier) {
        alert('Please enter your email or phone.');
        return;
      }
      fetch('/api/check_customer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({identifier: identifier})
      })
      .then(res => {
        if (!res.ok) throw new Error('API error');
        return res.json();
      })
      .then(data => {
        if (data.exists) {
          handleCustomerSuccess('existing', data.customer);
        } else {
          alert('Customer not found. Please register as new customer.');
        }
      })
      .catch(err => alert('Error checking customer: ' + err.message));
    } else {
      const name = document.getElementById('newName').value.trim();
      const email = document.getElementById('newEmail').value.trim();
      const phone = document.getElementById('newPhone').value.trim();
      const address = document.getElementById('newAddress').value.trim();
      if (!name || !email) {
        alert('Please enter your name and email.');
        return;
      }
      const newCustomerData = { name, email, phone, address };
      fetch('/api/add_customer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(newCustomerData)
      })
      .then(res => {
        if (res.ok) return res.json();
        return res.json().then(err => { throw new Error(err.detail || 'Failed to add customer') });
      })
      .then(data => {
        handleCustomerSuccess('new', newCustomerData);
      })
      .catch(err => alert('Error adding customer: ' + err.message));
    }
  });
</script>
</body>
</html>
